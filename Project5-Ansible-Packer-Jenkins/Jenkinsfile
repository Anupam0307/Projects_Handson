pipeline {
  agent any

  environment {
    AWS_REGION      = "ap-south-1"
    DOCKERHUB_USER  = "anupam0307"
    IMAGE_NAME      = "node-app"
    IMAGE_TAG       = "${BUILD_NUMBER}"
    PROJECT_DIR     = "Project5-Ansible-Packer-Jenkins"
    AMI_NAME_PREFIX = "devops-base-ami-"

    AWS_ACCESS_KEY_ID     = credentials('aws-access-key')
    AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key')
  }

  stages {

    stage('Build AMI with Packer') {
      when {
        expression {
          sh(
            script: """
              aws ec2 describe-images \
                --owners self \
                --filters "Name=name,Values=${AMI_NAME_PREFIX}*" \
                --query 'Images | length(@)' \
                --output text
            """,
            returnStdout: true
          ).trim() == "0"
        }
      }

      steps {
        dir("${PROJECT_DIR}/packer") {
          sh '''
            export AWS_DEFAULT_REGION=${AWS_REGION}
            packer init ec2-ami.pkr.hcl
            packer build ec2-ami.pkr.hcl
          '''
        }
      }
    }

    stage('Terraform Plan') {
      steps {
        dir("${PROJECT_DIR}/terraform") {
          sh '''
            export AWS_DEFAULT_REGION=${AWS_REGION}
            terraform init

            AMI_ID=$(aws ec2 describe-images \
              --owners self \
              --filters "Name=name,Values=${AMI_NAME_PREFIX}*" \
              --query 'Images | sort_by(@,&CreationDate)[-1].ImageId' \
              --output text)

            terraform plan \
              -var="ami_id=$AMI_ID" \
              -var="aws_region=${AWS_REGION}"
          '''
        }
      }
    }

    stage('Manual Approval') {
      steps {
        input message: 'Approve Terraform Apply?', ok: 'Apply'
      }
    }

    stage('Terraform Apply') {
      steps {
        dir("${PROJECT_DIR}/terraform") {
          sh '''
            export AWS_DEFAULT_REGION=${AWS_REGION}

            AMI_ID=$(aws ec2 describe-images \
              --owners self \
              --filters "Name=name,Values=${AMI_NAME_PREFIX}*" \
              --query 'Images | sort_by(@,&CreationDate)[-1].ImageId' \
              --output text)

            terraform apply -auto-approve \
              -var="ami_id=$AMI_ID" \
              -var="aws_region=${AWS_REGION}"
          '''
        }
      }
    }

    stage('Configure EC2 with Ansible') {
      steps {
        dir("${PROJECT_DIR}/ansible") {
          sh '''
            export AWS_DEFAULT_REGION=${AWS_REGION}
            ansible-playbook playbook.yml
          '''
        }
      }
    }

    stage('Build & Push Docker Image') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'dockerhub-creds',
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          dir("${PROJECT_DIR}/app") {
            sh '''
              echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
              docker build -t ${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG} .
              docker push ${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG}
            '''
          }
        }
      }
    }

    stage('Deploy to EKS') {
      steps {
        dir("${PROJECT_DIR}/k8s") {
          sh '''
            export AWS_DEFAULT_REGION=${AWS_REGION}

            aws eks update-kubeconfig \
              --region ${AWS_REGION} \
              --name my-eks-cluster

            sed "s/IMAGE_TAG/${IMAGE_TAG}/g" deployment.yaml > deployment_rendered.yaml
            kubectl apply -f deployment_rendered.yaml
            kubectl apply -f service.yaml
          '''
        }
      }
    }
  }
}
